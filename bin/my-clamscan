#!/usr/bin/env bash

# my-clamscan.sh
# Varredura antivírus com clamscan:
# - move arquivos infectados para quarentena
# - gera log apenas com as detecções
#
# Uso:
#   my-clamscan.sh <arquivo|diretório>
#   (sem argumento, varre o diretório atual)
#
# Exemplo (Thunar → ação personalizada):
#   alacritty -e ~/.local/bin/my-clamscan %f

# Diretórios e arquivos usados pelo script
BASE_DIR="$HOME/.local/share/my-clamscan"
INFECTED_DIR="$BASE_DIR/infected"
LOG_FILE="$BASE_DIR/infecteds-$(date +'%Y-%m-%d').log"

# Arquivo temporário para capturar o log do clamscan
TMPFILE="$(mktemp -p /tmp my-clamscan.XXXXXXXXXX)"

# Garante limpeza do arquivo temporário ao sair
trap 'rm -f "$TMPFILE"' EXIT

# Verifica dependências
if ! command -v clamscan >/dev/null 2>&1; then
  echo "Erro: clamscan não encontrado no PATH." >&2
  exit 2
fi

if ! command -v dunstify >/dev/null 2>&1; then
  echo "Erro: dunstify não encontrado no PATH." >&2
  exit 2
fi

# Alvo informado ou diretório atual
TARGET="${1:-.}"

# Valida se o alvo existe
if [ ! -e "$TARGET" ]; then
  echo "Caminho inválido: '$TARGET'" >&2
  exit 2
fi

# Cria diretórios necessários
mkdir -p "$BASE_DIR" "$INFECTED_DIR"

# Executa a varredura
# Códigos de saída:
#   0 = nenhum vírus encontrado
#   1 = vírus encontrado(s)
#  >1 = erro
clamscan --recursive \
  --alert-encrypted \
  --exclude-dir="$INFECTED_DIR" \
  --move="$INFECTED_DIR" \
  --log="$TMPFILE" \
  "$TARGET"

CLAM_EXIT=$?

# Registra apenas arquivos infectados no log diário
# Se encontrou vírus, registra log e notifica
if [ "$CLAM_EXIT" -eq 1 ]; then
  FOUND_COUNT=$(grep -c -- "FOUND" "$TMPFILE" || true)

  {
    printf '%s\n' "$(date +'%Y-%m-%d %H:%M:%S') ---------------------"
    grep -- "FOUND" "$TMPFILE" || true
    printf '\n'
  } >> "$LOG_FILE"

  dunstify \
    -u critical \
    -i dialog-warning \
    -t 0 \
    "ClamAV: Ameaça detectada" \
    "$FOUND_COUNT arquivo(s) infectado(s) movidos para quarentena."

# Se ocorreu erro
elif [ "$CLAM_EXIT" -gt 1 ]; then
  dunstify \
    -u critical \
    -i dialog-error \
    -t 0 \
    "ClamAV: Erro na varredura" \
    "Falha ao escanear '$TARGET' (código $CLAM_EXIT)."

  echo "Erro: clamscan falhou (código $CLAM_EXIT)" >&2

# Se finalizou sem vírus
else
  dunstify \
    -u normal \
    -i dialog-information \
    -t 5000 \
    "ClamAV: Varredura concluída" \
    "Nenhuma ameaça encontrada."
fi

# Aguarda interação do usuário antes de sair (uso via Thunar)
if [ -t 1 ]; then
  echo
  echo "Pressione 'q' para sair..."
  while read -rsn1 key; do
    [[ $key == q ]] && break
  done
fi

# Retorna o mesmo código do clamscan
exit "$CLAM_EXIT"


